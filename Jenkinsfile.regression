kernelname = 'man_notebooker_regression_' + env.BRANCH_NAME + '_' + env.BUILD_ID

def installKernel = { medusaVersion ->
  def venvDir = getVenvDir(medusaVersion)
  pyInstall('ipykernel', venvDir)
  withActivate("python -m ipykernel install --name=${kernelname} --user",
               venvDir)
}


def regression = {
  pyTest 'tests/regression', "-m 'not compress and not serial'"
}


withEnv(['REGRESSION_TESTING="true"',"NOTEBOOK_KERNEL_NAME=${kernelname}"]) {
    ahlPython {
        acquireDotsDb(){
            buildLabel='ts2-el7'
            labels='ts2-el7'
            dockerImages: []
            buildPinnedEgg = false
            medusaVersions = ["27-3"]
            publicProject = true
            preventPushEgg = true
            coverage = false
            preBuildStages = [
                [name: 'Installing ipython kernel',
                 body: installKernel
                 ]
            ]
            testStages =  [
                [name: 'Template Regression tests',
                 body: regression
                 ]
            ]
        }
    }
}
